<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="UTF-8">
    <script src="js/three.min.js"></script>
    <script src="js/jquery-3.1.1.min.js"></script>
    <script src="js/pathfinding-browser.min.js"></script>
    <script src="js/MTLLoader.js"></script>
    <script src="js/OBJLoader.js"></script>

    <script src="js/Detector.js"></script>

    <script>
        myAudio = new Audio('sounds/background.ogg');
        myAudio.addEventListener('ended', function () {
            this.currentTime = 0;
            this.play();
        }, false);
        myAudio.volume = 0.5;
        myAudio.play();</script>


    <title>Title</title>
</head>
<body style="overflow: hidden; background-color:black;">
    <div id="gameInfo" style="position:absolute; color:white; left:500px">
        <p id="score"></p>
        <p>Health:  <progress id="health" max="100"></progress> </p>
        <p>Use arrow keys to move</p>
        <p>Press space to shoot</p>
        <p>Use number keys to change weapon</p>
        <p>Press p to pause/unpause</p>
    </div>
    <script>
        var lazerSound = new Audio('sounds/lazer.wav');
        var levelUpSound = new Audio('sounds/levelUp.wav');
        var score = 0;
        var health = 100;
        var isPaused = 0;
        var currentWeapon = 1;

        $(document).keydown(function (e) {
            switch (e.which) {
                case 80: //p
                    setPause();
                    break;
                default: return;
            }
            e.preventDefault();
        });

        function setPause() {
            if (isPaused == 0) {
                isPaused = 1;
                myAudio.pause();
            }
            else {
                isPaused = 0;
                myAudio.play();
                render();
            }
        }
        var playedLosingSound = 0;
        function setHealth() {
            document.getElementById('health').value = health;
        }
        function setScore() {
            document.getElementById('score').innerHTML = "Score:" + score;
        }
        var scene, renderer, camera;
        var cube;
        var playerDirection = 2;
        var level = 1;
        var zombieaantal = 5;
        var matrix = [
                [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
        ];
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(640, 480);
        document.body.appendChild(renderer.domElement);

        scene = new THREE.Scene();
        var lazerDirection;
        var cubeGeometry = new THREE.BoxGeometry(0.05, 0.05, 0.05);
        var lazerGeometry = new THREE.SphereGeometry(0.02, 8, 8);
        var lazerMaterial = new THREE.MeshLambertMaterial({ color: 0xff0000 });
        var cubeMaterial = new THREE.MeshLambertMaterial({ color: 0x1ec876 });
        var cubeMaterial2 = new THREE.MeshLambertMaterial({ color: 0x0000FF });
        var cubeMaterial3 = new THREE.MeshLambertMaterial({ color: 0xFF00FF });
        var cubeMaterial4 = new THREE.MeshLambertMaterial({ color: 0xFF0000 });
        var cubeMaterial5 = new THREE.MeshLambertMaterial({ color: 0x0F0F0F });
        var cubeMaterial6 = new THREE.MeshLambertMaterial({ color: 0xF0F0FF });
        var lazer = new THREE.Mesh(lazerGeometry, lazerMaterial);
        scene.add(lazer);
        lazer.position.set(-10, 0, 0);
        var barrel = new THREE.Mesh(cubeGeometry, cubeMaterial);
        scene.add(barrel);
        barrel.position.set(100, 0, 100);
        cube = new THREE.Mesh(cubeGeometry, cubeMaterial);



        cube2 = new THREE.Mesh(cubeGeometry, cubeMaterial2);

        cube.position.set(0.1, 0, 0.1);
        //cube2.position.set(0.5, 0, 0.9);

        scene.add(cube);
        var gridXZ = new THREE.GridHelper(1, 20, 0xff4040, 0x0000ff);
        gridXZ.position.x += 1;
        gridXZ.position.z += 1;
        scene.add(gridXZ);

        camera = new THREE.PerspectiveCamera(45, 640 / 480, 0.1, 10000);
        camera.position.y = 3;
        camera.position.x += 1.5;
        camera.rotation.x = -0.9;
        camera.position.z += 2;
        camera.lookAt(new THREE.Vector3(1.5, 0, 1));

        var pointLight = new THREE.PointLight(0xffffff);
        pointLight.position.set(0, 300, 200);
        scene.add(pointLight);
        function levelcalc() {
            level++;
            zombies = [];
            zombieHealthList = [];
            pathlist = [];
            finderlist = [];
            gridlist = [];
            zombieaantal = 5;
            spawnzombies = 0;
            zombiespawner();
            zombielist();

        }
        function zombiespawner() {
            zombieaantal = zombieaantal * level;
            for (var i = 0; i < zombieaantal; i++) {
                zombieHealthList[i] = 100;
            }
            if (zombieaantal > 50) {
                zombieaantal = 50;
            }
        }
        var zombies = [];
        var finderlist = [];
        var gridlist = [];
        var zombieHealthList = [];
        zombiespawner();
        zombielist();

        var spawnzombies = 0;
        function zombielist() {

            //var minus = 0.0;

            //for (i = 0; i < zombies.length; i++)
            //{
            //    var mesh = new THREE.Mesh(cubeGeometry, cubeMaterial2);
            //    minus = minus + (i / 10);
            //    zombies[i] = mesh;
            //    zombies[i].position.set((1.9-minus), 0, (1.9-minus));
            //    scene.add(zombies[0]);
            //}

            /* zombies[0] = cube2;
             zombies[0].position.set(1.9, 0, 1.9);
             scene.add(zombies[0])

             zombies[1] = cube3;
             zombies[1].position.set(1.8, 0, 1.8);
             scene.add(zombies[1])

             zombies[2] = cube4;
             zombies[2].position.set(1.7, 0, 1.7);
             scene.add(zombies[2])

             zombies[3] = cube5;
             zombies[3].position.set(1.6, 0, 1.6);
             scene.add(zombies[3])

             zombies[4] = cube6;
             zombies[4].position.set(1.5, 0, 1.5);
             scene.add(zombies[4])*/

            var spawnpoint1 = setInterval(function () {
                if (spawnzombies >= zombieaantal - 2) {
                    clearInterval(spawnpoint1)
                }
                finderlist[spawnzombies] = new PF.AStarFinder({
                    allowDiagonal: true,
                    dontCrossCorners: true
                });

                zombies[spawnzombies] = cube2.clone();
                zombies[spawnzombies].position.set(1.9, 0, 1.9);
                scene.add(zombies[spawnzombies])

                spawnzombies++;

            }, 500);

            var spawnpoint2 = setInterval(function () {
                if (spawnzombies >= zombieaantal - 2) {
                    clearInterval(spawnpoint2)
                }
                finderlist[spawnzombies] = new PF.AStarFinder({
                    allowDiagonal: true,
                    dontCrossCorners: true
                });

                zombies[spawnzombies] = cube2.clone();
                zombies[spawnzombies].position.set(1.6, 0, 1.6);
                scene.add(zombies[spawnzombies])

                spawnzombies++;

            }, 505);


            /*for (var i = 0; i < zombieaantal; i++) {
                finderlist[i] = new PF.AStarFinder({
                    allowDiagonal: true,
                    dontCrossCorners: true
                });
                if(i % 2 ==0) {
                    zombies[i] = cube2;
                    zombies[i].position.set(1.9, 0, 1.9);
                    scene.add(zombies[0])
                    zombieHealthList[i] = 100;

                }else{
                    zombies[i] = cube2;
                    zombies[i].position.set(1.6, 0, 1.6);
                    scene.add(zombies[0])
                    zombieHealthList[i] = 100;
                }


            }*/



            /*
                    for(b = 0; b < zombieaantal; b++)
                    {
                        zombies[b].position.x = (b / 2 ) + 0.5;
                        zombies[b].position.z = (b / 2) + 0.5;
                        zombies[b].position.y = 0;
                    }
            */
        }

        var path;
        var pathlist = [];
        var startx = 0;
        var startz = 0;
        var endx = 0;
        var endz = 0;



        //var finder = new PF.AStarFinder({
        //    allowDiagonal: true,
        //    dontCrossCorners: true
        //});


        function pathfinder() {

            if (isPaused == 0) {
                endx = Math.round(cube.position.x * 10);
                endz = Math.round(cube.position.z * 10);


                for (c = 0; c < zombies.length; c++) {

                    if (zombieHealthList[c] > 0) {
                        gridlist[c] = new PF.Grid(matrix);
                        startx = Math.round(zombies[c].position.x * 10);
                        startz = Math.round(zombies[c].position.z * 10);
                        pathlist[c] = (finderlist[c].findPath(startx, startz, endx, endz, gridlist[c])).slice(0, 2);
                        matrix[pathlist[c][0][1]][pathlist[c][0][0]] = 0;

                        zombies[c].position.x = (pathlist[c][1][0]) / 10;
                        zombies[c].position.z = (pathlist[c][1][1]) / 10;

                        matrix[pathlist[c][1][1]][pathlist[c][1][0]] = 1;
                    }


                }

            }

        }


        pathfinder();
        function timer() {
            setInterval(function () {
                pathfinder();
            }, 700);
            setInterval(function () {
                checkZombiesHealth();
            }, 4000)

        }
        var isImmuneToDamge = 0;

        //Start render function
        function render() {

            if (lazer.position.x > 2 || lazer.position.x < 0 || lazer.position.z > 2 || lazer.position.z < 0) {
                lazer.position.x += 100;
                lazer.position.z += 100;
            }


            if (lazerDirection == 1) {
                lazer.position.z -= 0.1;
            }
            else if (lazerDirection == 2) {
                lazer.position.x += 0.1;
            }
            else if (lazerDirection == 3) {
                lazer.position.z += 0.1;
            }
            else if (lazerDirection == 4) {
                lazer.position.x -= 0.1;
            }

            if (isPaused == 0) {
                requestAnimationFrame(render);
                isImmuneToDamge = 0;


                for (var c = 0; c < zombies.length; c++) {

                    //if zombie gets hit
                    if (Math.abs(lazer.position.x - zombies[c].position.x) < 0.1 && Math.abs(lazer.position.z - zombies[c].position.z) < 0.1) {

                        lazer.position.x += 100;
                        zombieHealthList[c] = zombieHealthList[c] - 100;
                        console.log("zombie#" + c + " health: " + zombieHealthList[c])
                        score += 20;
                    }

                    //checks if zombie is dead
                    if (zombieHealthList[c] <= 0 && zombies[c].position.y > -1) {
                        matrix[Math.round(zombies[c].position.z * 10)][Math.round(zombies[c].position.x * 10)] = 0;

                        zombies[c].position.x = -100;
                        zombies[c].position.y = -100;
                        zombies[c].position.z = -100;

                    }

                    var zombiePosX = Math.round(zombies[c].position.x * 10);
                    var zombiePosZ = Math.round(zombies[c].position.z * 10);
                    var playerPosX = Math.round(cube.position.x * 10);
                    var playerPosZ = Math.round(cube.position.z * 10);

                    //If zombie touches player
                    if (zombiePosX == playerPosX && zombiePosZ == playerPosZ && isImmuneToDamge == 0) {
                        health--;
                        console.log(health);
                    }
                }

                //When health reaches 0
                if (health <= 0) {

                    //sets losing screen image
                    var img = document.createElement("img");
                    img.src = "images/lose.png";
                    img.width = 680;
                    img.height = 480;
                    img.alt = "You lost";
                    img.style.position = "absolute";
                    img.style.left = "0px";
                    // This next line will just add it to the <body> tag
                    document.body.appendChild(img);
                    zombies = [];

                    pathlist = [];
                    finderlist = [];
                    gridlist = [];
                    zombieaantal = 5;
                    spawnzombies = 0;
                    zombieHealthList[0] = 100;
                    //plays losing sound
                    if (playedLosingSound == 0) {
                        myAudio.pause();
                        myAudio.currentTime = 0;
                        var LosingSound = new Audio('sounds/lose.wav');

                        LosingSound.play();
                        playedLosingSound = 1;
                    }

                }




                setHealth();
                setScore();
                renderer.render(scene, camera);
            }
        }

        //zombielist();
        timer();
        render();
        var totalBarrels = 0;

        $(document).keydown(function (e) {
            switch (e.which) {
                case 32: //space
                    if (currentWeapon == 1) {
                        lazer.position.x = cube.position.x;
                        lazer.position.z = cube.position.z;
                        lazerDirection = playerDirection;
                        lazerSound.play();
                    }
                    else if (currentWeapon == 2 && totalBarrels<5) {
                        var newBarrel = barrel.clone();
                        scene.add(newBarrel);
                        newBarrel.position.x = cube.position.x;
                        newBarrel.position.z = cube.position.z;
                        matrix[Math.round(newBarrel.position.z * 10)][Math.round(newBarrel.position.x * 10)] = 1;
                        totalBarrels++;
                    }
                    break;
                case 37: // left
                    playerDirection = 4;
                    if ((matrix[Math.round(cube.position.z * 10)][Math.round(cube.position.x * 10) - 1]) == 0) {
                        cube.position.x -= 0.1;
                    }
                    break;

                case 38: // up
                    playerDirection = 1;
                    if ((matrix[Math.round(cube.position.z * 10) - 1][Math.round(cube.position.x * 10)]) == 0) {
                        cube.position.z -= 0.1;
                    }
                    break;

                case 39: // right
                    playerDirection = 2;
                    if ((matrix[Math.round(cube.position.z * 10)][Math.round(cube.position.x * 10) + 1]) == 0) {
                        cube.position.x += 0.1;
                    }
                    break;

                case 40: // down
                    playerDirection = 3;
                    if ((matrix[Math.round(cube.position.z * 10) + 1][Math.round(cube.position.x * 10)]) == 0) {
                        cube.position.z += 0.1;
                    }
                    break;
                case 49: //1
                    currentWeapon = 1;
                    console.log(currentWeapon);
                    break;
                case 50: //2
                    currentWeapon = 2;
                    console.log(currentWeapon);
                    break;



                default: return;
            }
            e.preventDefault();
        });

        function checkZombiesHealth() {
            var zombieHealthSum = 0;
            for (var i = 0; i < zombies.length; i++) {
                if (zombies[i].position.y == -100) {
                    zombieHealthList[i] = 0;
                }
                else {
                    zombieHealthSum = 1;
                }
            }
            if (zombieHealthSum <= 0 && zombies.length > 0) {
                levelUpSound.play();
                levelcalc();
            }
        }





    </script>
</body>
</html>