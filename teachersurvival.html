<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="UTF-8">
    <script src="js/three.min.js"></script>
    <script src="js/jquery-3.1.1.min.js"></script>
    <script src="js/pathfinding-browser.min.js"></script>
    <script src="js/MTLLoader.js"></script>
    <script src="js/OBJLoader.js"></script>

    <script src="js/Detector.js"></script>

    <script>
myAudio = new Audio('sounds/background.ogg');
        myAudio.addEventListener('ended', function () {
            this.currentTime = 0;
            this.play();
        }, false);
        myAudio.play();</script>


    <title>Title</title>
</head>
<body style="overflow: hidden;">
    <div id="gameInfo" style="position:absolute; left:435px">
        <p id="score" style="color:white;"></p>
        <p style="color:white;">Health:  <progress id="health" max="100"></progress> </p>
    </div>
    <script>
        var score = 0;
        var health = 100;
        var playedLosingSound = 0;
        function setHealth() {
            document.getElementById('health').value = health;
        }
        function setScore() {
            document.getElementById('score').innerHTML = "Score:" + score;
        }
        var scene, renderer, camera;
        var cube;
        var level = 1;
        var zombieaantal = 5;
        var matrix = [
                [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
        ];
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(640, 480);
        document.body.appendChild(renderer.domElement);

        scene = new THREE.Scene();

        var cubeGeometry = new THREE.BoxGeometry(0.05, 0.05, 0.05);
        var cubeMaterial = new THREE.MeshLambertMaterial({ color: 0x1ec876 });
        var cubeMaterial2 = new THREE.MeshLambertMaterial({ color: 0x0000FF });
        var cubeMaterial3 = new THREE.MeshLambertMaterial({ color: 0xFF00FF });
        var cubeMaterial4 = new THREE.MeshLambertMaterial({ color: 0xFF0000 });
        var cubeMaterial5 = new THREE.MeshLambertMaterial({ color: 0x0F0F0F });
        var cubeMaterial6 = new THREE.MeshLambertMaterial({ color: 0xF0F0FF });
        cube = new THREE.Mesh(cubeGeometry, cubeMaterial);
        cube2 = new THREE.Mesh(cubeGeometry, cubeMaterial2);
        cube3 = new THREE.Mesh(cubeGeometry, cubeMaterial3);
        cube4 = new THREE.Mesh(cubeGeometry, cubeMaterial4);
        cube5 = new THREE.Mesh(cubeGeometry, cubeMaterial5);
        cube6 = new THREE.Mesh(cubeGeometry, cubeMaterial6);
        cube.position.set(0.1, 0, 0.1);
        //cube2.position.set(0.5, 0, 0.9);

        scene.add(cube);
        var gridXZ = new THREE.GridHelper(1, 20, 0xff4040, 0x0000ff);
        gridXZ.position.x += 1;
        gridXZ.position.z += 1;
        scene.add(gridXZ);

        camera = new THREE.PerspectiveCamera(45, 640 / 480, 0.1, 10000);
        camera.position.y = 3;
        camera.position.x += 1.5;
        camera.rotation.x = -1;
        camera.position.z += 1;
        camera.lookAt(new THREE.Vector3(1.5, 0, 1));

        var pointLight = new THREE.PointLight(0xffffff);
        pointLight.position.set(0, 300, 200);
        scene.add(pointLight);
        function levelcalc() {

        }
        function zombiespawner() {
            zombieaantal = zombieaantal * level;

        }
        var zombies = [];
        var finderlist = [];
        var gridlist = [];
        function zombielist() {

            //var minus = 0.0;

            //for (i = 0; i < zombies.length; i++)
            //{
            //    var mesh = new THREE.Mesh(cubeGeometry, cubeMaterial2);
            //    minus = minus + (i / 10);
            //    zombies[i] = mesh;
            //    zombies[i].position.set((1.9-minus), 0, (1.9-minus));
            //    scene.add(zombies[0]);
            //}

            zombies[0] = cube2;
            zombies[0].position.set(1.9, 0, 1.9);
            scene.add(zombies[0])

            zombies[1] = cube3;
            zombies[1].position.set(1.8, 0, 1.8);
            scene.add(zombies[1])

            zombies[2] = cube4;
            zombies[2].position.set(1.7, 0, 1.7);
            scene.add(zombies[2])

            zombies[3] = cube5;
            zombies[3].position.set(1.6, 0, 1.6);
            scene.add(zombies[3])

            zombies[4] = cube6;
            zombies[4].position.set(1.5, 0, 1.5);
            scene.add(zombies[4])

            for (var i = 0; i < zombies.length; i++) {
                finderlist[i] = new PF.AStarFinder({
                    allowDiagonal: true,
                    dontCrossCorners: true
                });





            }



            /*
                    for(b = 0; b < zombieaantal; b++)
                    {
                        zombies[b].position.x = (b / 2 ) + 0.5;
                        zombies[b].position.z = (b / 2) + 0.5;
                        zombies[b].position.y = 0;
                    }
            */
        }
        zombielist();
        var path;
        var pathlist = [];
        var startx = 0;
        var startz = 0;
        var endx = 0;
        var endz = 0;



        //var finder = new PF.AStarFinder({
        //    allowDiagonal: true,
        //    dontCrossCorners: true
        //});


        function pathfinder() {
            endx = Math.round(cube.position.x * 10);
            endz = Math.round(cube.position.z * 10);


            for (c = 0; c < zombies.length; c++) {


                gridlist[c] = new PF.Grid(matrix);
                startx = Math.round(zombies[c].position.x * 10);
                startz = Math.round(zombies[c].position.z * 10);
                pathlist[c] = (finderlist[c].findPath(startx, startz, endx, endz, gridlist[c])).slice(0, 2);
                matrix[pathlist[c][0][1]][pathlist[c][0][0]] = 0;

                zombies[c].position.x = (pathlist[c][1][0]) / 10;
                zombies[c].position.z = (pathlist[c][1][1]) / 10;

                matrix[pathlist[c][1][1]][pathlist[c][1][0]] = 1;




            }

        }
        var ancoIndex = [];
        for (i = 0; i < zombies.length; i++) {
            ancoIndex[i] = [2, 2];
        }



        pathfinder();
        function timer() {
            setInterval(function () {
                pathfinder();
            }, 700);

        }
        var isImmuneToDamge = 0;
        function render() {
            requestAnimationFrame(render);
            isImmuneToDamge = 0;

            //If zombie touches player
            for (var c = 0; c < zombies.length; c++) {
                var zombiePosX = Math.round(zombies[c].position.x * 10);
                var zombiePosZ = Math.round(zombies[c].position.z * 10);
                var playerPosX = Math.round(cube.position.x * 10);
                var playerPosZ = Math.round(cube.position.z * 10);
                if (zombiePosX == playerPosX && zombiePosZ == playerPosZ && isImmuneToDamge == 0) {
                    health--;
                    console.log(health);
                }
            }

            //When health reaches 0
            if (health < 0) {

                //sets losing screen image
                var img = document.createElement("img");
                img.src = "images/lose.png";
                img.width = 680;
                img.height = 480;
                img.alt = "You lost";
                img.style.position = "absolute";
                img.style.left = "0px";
                // This next line will just add it to the <body> tag
                document.body.appendChild(img);

                //plays losing sound
                if (playedLosingSound == 0) {
                    myAudio.pause();
                    myAudio.currentTime = 0;
                   var LosingSound = new Audio('sounds/lose.wav');
                    
                    LosingSound.play();
                    playedLosingSound = 1;
                }

            }




            setHealth();
            setScore();
            renderer.render(scene, camera);
        }
        zombiespawner();
        //zombielist();
        timer();
        render();

        $(document).keydown(function (e) {
            switch (e.which) {
                case 37: // left
                    if ((matrix[Math.round(cube.position.z * 10)][Math.round(cube.position.x * 10) - 1]) == 0) {
                        cube.position.x -= 0.1;
                    }
                    break;

                case 38: // up
                    if ((matrix[Math.round(cube.position.z * 10) - 1][Math.round(cube.position.x * 10)]) == 0) {
                        cube.position.z -= 0.1;
                    }
                    break;

                case 39: // right
                    if ((matrix[Math.round(cube.position.z * 10)][Math.round(cube.position.x * 10) + 1]) == 0) {
                        cube.position.x += 0.1;
                    }
                    break;

                case 40: // down
                    if ((matrix[Math.round(cube.position.z * 10) + 1][Math.round(cube.position.x * 10)]) == 0) {
                        cube.position.z += 0.1;
                    }
                    break;


                default: return;
            }
            e.preventDefault();
        });


    </script>
</body>
</html>